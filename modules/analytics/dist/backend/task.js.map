{"version":3,"sources":["task.ts"],"names":["UpdateTask","constructor","_bp","_interval","start","botId","_intervalRef","Error","setInterval","_runTaskWhenReady","bind","stop","clearInterval","undefined","_currentPromise","runTask","catch","err","logger","warn","message","finally"],"mappings":";;;;;;;;;AAAO,MAAMA,UAAN,CAAiB;AAMtBC,EAAAA,WAAW,CAASC,GAAT,EAAsBC,SAAtB,EAAyC;AAAA,SAAhCD,GAAgC,GAAhCA,GAAgC;AAAA,SAAnBC,SAAmB,GAAnBA,SAAmB;;AAAA;;AAAA;;AAAA;AAAE;;AAEtD,QAAMC,KAAN,CAAYC,KAAZ,EAAmB;AACjB,QAAI,KAAKC,YAAT,EAAuB;AACrB,YAAM,IAAIC,KAAJ,CAAU,gCAAV,CAAN;AACD;;AACD,SAAKD,YAAL,GAAoBE,WAAW,CAAC,KAAKC,iBAAL,CAAuBC,IAAvB,CAA4B,IAA5B,CAAD,EAAoC,KAAKP,SAAzC,CAA/B;AACD;;AAEDQ,EAAAA,IAAI,CAACN,KAAD,EAAQ;AACVO,IAAAA,aAAa,CAAC,KAAKN,YAAN,CAAb;AACA,SAAKA,YAAL,GAAoBO,SAApB;AACD;;AAED,QAAcJ,iBAAd,GAAkC;AAChC,QAAI,KAAKK,eAAT,EAA0B;AACxB;AACD;;AAED,SAAKA,eAAL,GACE,KAAKC,OAAL,IACA,KAAKA,OAAL,GACGC,KADH,CACSC,GAAG,IAAI,KAAKf,GAAL,CAASgB,MAAT,CAAgBC,IAAhB,CAAqB,2BAA2BF,GAAG,CAACG,OAApD,CADhB,EAEGC,OAFH,CAEW,MAAM;AACb,WAAKP,eAAL,GAAuBD,SAAvB;AACD,KAJH,CAFF;AAOD;;AAhCqB","sourceRoot":"/Users/renaud/Code/Botpress/botpress/modules/analytics/src/backend","sourcesContent":["export class UpdateTask {\n  public runTask: (() => Promise<void>) | undefined\n\n  private _currentPromise\n  private _intervalRef\n\n  constructor(private _bp, private _interval: number) {}\n\n  async start(botId) {\n    if (this._intervalRef) {\n      throw new Error('The update is already running.')\n    }\n    this._intervalRef = setInterval(this._runTaskWhenReady.bind(this), this._interval)\n  }\n\n  stop(botId) {\n    clearInterval(this._intervalRef)\n    this._intervalRef = undefined\n  }\n\n  private async _runTaskWhenReady() {\n    if (this._currentPromise) {\n      return\n    }\n\n    this._currentPromise =\n      this.runTask &&\n      this.runTask()\n        .catch(err => this._bp.logger.warn('Error running update: ' + err.message))\n        .finally(() => {\n          this._currentPromise = undefined\n        })\n  }\n}\n"]}